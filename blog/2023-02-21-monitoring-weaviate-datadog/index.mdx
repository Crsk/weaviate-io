---
title: Monitoring Weaviate in Production
slug: monitoring-weaviate-in-production
authors: jt
date: 2023-02-21
tags: []
---

Weaviate aims to be easy to monitor and observe by following a cloud native approach. When
deploying Weaviate to Kubernetes it does the following:

1. Publishes prometheus metrics to the standard `/metrics` endpoint

2. Has built-in liveness and readiness checks

3. Is configurable by environment variables

We have documentation on [the exported metrics](https://weaviate.io/developers/weaviate/configuration/monitoring) and
also provide [an example](https://github.com/weaviate/weaviate-examples/tree/main/monitoring-prometheus-grafana) for
how to use a Prometheus instance for metric storage.

One common question though that comes up is how can I integrate Weaviate with my existing monitoring / observability
solution? This article describes two approaches using either Grafana agent or Datadog agent
to scrape these metrics. It also provides a list of the most important metrics to monitor.

It is assumed that Weaviate has been deployed via the [helm charts](https://weaviate.io/developers/weaviate/installation/kubernetes) though this can be adapted to docker compose. Check that Prometheus monitored has been enabled:

```sh
PROMETHEUS_MONITORING_ENABLED=true
```

*Note:* If you are using Weaviate 1.18 or lower, you may want to upgrade before enabling Prometheus metrics. The reason being
Weaviate previously published many histograms which has since been replaced by summaries for performance reasons. Additionally
be careful enabling prometheus metrics if you have thousands of classes as many metrics are produced per class.

## Grafana agent

A benefit of using Grafana agent and pushing to managed Mimir / Prometheus instance is you can reuse the existing
dashboards that come with Weaviate.

### Steps to install

1. Install Grafana agent in your target environment following [their set up guide](https://grafana.com/docs/agent/latest/set-up/).

2. Configure the Grafana `agent.yaml` to include a scrape job called `weaviate`. In this case the Weaviate pods are getting
autodiscovered in Kubernetes. The `app=weaviate` label is automatically added by the Weaviate helm chart.

```yaml
metrics:
    configs:
    - name: weaviate
    # reference https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config
    scrape_configs:
    - job_name: weaviate
        scrape_interval: 30s
        scheme: http
        metrics_path: /metrics
        kubernetes_sd_configs:
        - role: pod
        selectors:
        - role: "pod"
            label: "app=weaviate"
    remote_write:
    - url: <Your Grafana.com prometheus push url>
        basic_auth:
        username: <Your Grafana.com userid>
        password: <Your Grafana.com API Key>
```

3. To validate that you are receiving data run the following query in Grafana.

```
go_memstats_heap_inuse_bytes{job="weaviate"}
```

4. Load the prexisting dashboards from https://github.com/weaviate/weaviate/tree/master/tools/dev/grafana/dashboards.

TODO: write detailed steps for this

![query latency](./img/query-latency.png)

# Option 2 - Datadog

1. Install the datadog agent, for this example installation was done using [Helm](https://docs.datadoghq.com/containers/kubernetes/installation/?tab=helm).

2. Provide datadog-values.yml including the following:

```yaml
datadog:
# Note DD_KUBELET_TLS_VERIFY only needs to be set if running a local docker kubernetes cluster
#  env:
#  - name: DD_KUBELET_TLS_VERIFY
#    value: "false"
  clusterName: weaviate-deployment
  prometheusScrape:
    enabled: true
    serviceEndpoints: true
    additionalConfigs:
      - configurations:
        - max_returned_metrics: 20000
          min_collection_interval: 30
```

3. Customise the Weaviate helm chart to have annotations `prometheus.io/scrape` and `prometheus.io/port`

```yaml
# Pass any annotations to Weaviate pods
annotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "2112"
```

4. Validate metrics are available. `go_memstats_heap_inuse_bytes` should always be present even with an empty schema.

![datadog summary](./img/datadog-summary.png)

5. Dashboards

TODO: show sample dashboards

# TODO: Key metrics

Weaviate can be monitored by the Datadog agent via deploying the Datadog helm chart.

# Other aspects

Pull container logs.
Monitor and alert kubeneretes events using your standard tooling.

- https://docs.elastic.co/integrations/prometheus
- https://www.splunk.com/en_us/blog/devops/metrics-from-prometheus-exporters-are-now-available-with-the-sfx-smart-agent.html